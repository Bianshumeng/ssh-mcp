# 技术设计

## 背景与约束

- 背景：现有 `ssh-mcp` 仅支持单目标 CLI 参数，运行期不可切换。
- 约束：必须兼容旧用法；禁止泄露明文密码；不引入数据库和 UI。

## 目标

- 建立本地配置模板能力（YAML/JSON + ENV 展开）。
- 支持 profile 切换、重载、备注更新。
- 将单文件拆分为可维护分层结构。

## 不做（Non-Goals）

- 不新增 Web UI。
- 不改 MCP 协议和现有工具参数语义。
- 不实现多租户与权限系统。

## 技术决策

| 决策点 | 选择 | 原因 | 放弃方案 |
|--------|------|------|----------|
| 配置格式 | YAML 优先，兼容 JSON | YAML 便于运维编辑，JSON 兼容机器生成 | 仅 CLI 参数（无法支撑多 profile） |
| 配置校验 | Zod Schema | 与现有项目依赖一致，可维护性高 | 手写校验（易漏边界） |
| profile 生命周期 | 独立 `ProfileManager` | 解耦入口与连接逻辑，利于测试 | 继续堆在 `index.ts` |
| 工具拆分 | `src/tools/*` | 工具职责清晰，便于扩展 | 单文件注册全部工具 |
| 敏感输出 | 统一 summary 脱敏 | 降低误泄露风险 | 各处临时拼接输出 |

## 风险与缓解

| 风险 | 缓解措施 |
|------|----------|
| 新参数与旧参数冲突导致行为不确定 | 明确冲突校验并显式报错 |
| profile 切换后连接未重建 | 切换时强制关闭旧连接并懒加载新连接 |
| ENV 缺失导致启动失败 | 在加载阶段报出缺失变量名，阻止进入运行态 |
| 密钥路径错误 | 启动校验 keyPath 存在并给出清晰错误 |

## 迁移/回滚方案

- 迁移步骤：
  - 按模块拆分现有逻辑
  - 接入 profile 模式与管理工具
  - 更新文档与示例
- 回滚步骤：
  - 回退到改造前提交
  - 只保留原有 `--host --user` 入口
- 验证方式：
  - 运行新增单测
  - 运行旧模式兼容验证
  - 运行 profile 切换闭环验证

